<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StratBadEPS - v2.9.5</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--white:#e6eef6;--danger:#ef4444;--success:#10b981}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, sans-serif;background:#071029;color:var(--white);min-height:100vh;padding:10px}
    .app{width:100%;max-width:980px;margin:0 auto}
    .card{background:rgba(255,255,255,0.03);padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.4);margin-bottom:15px;border:1px solid rgba(255,255,255,0.05)}
    .btn{padding:12px;border-radius:10px;border:0;background:var(--accent);color:#012;cursor:pointer;font-weight:600;transition:all 0.2s;text-align:center}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.2);color:var(--white)}
    .hidden{display:none}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.05);text-align:left;font-size:13px}
    th{color:var(--accent);text-transform:uppercase;font-size:11px}
    .degre-badge{padding:4px 8px;border-radius:4px;font-weight:bold;font-size:11px;display:inline-block}
    .D1{background:#991b1b;color:white}.D2minus{background:#78350f;color:white}.D2{background:#92400e;color:white}
    .D3minus{background:#065f46;color:white}.D3{background:#166534;color:white}.D4minus{background:#0e7490;color:white}.D4{background:var(--accent);color:#012}
    .score-box{text-align:center;flex:1}.score-val{font-size:50px;font-weight:bold;margin:5px 0}
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;z-index:100;padding:20px}
    .modal-content{background:var(--card);padding:25px;border-radius:15px;max-width:700px;border:1px solid var(--accent);max-height:90vh;overflow-y:auto}
    #saveIndicator{font-size:10px;color:var(--success);opacity:0;transition:opacity 0.3s}
    input{width:100%;padding:12px;margin-bottom:8px;background:#000;color:#fff;border:1px solid #333;border-radius:8px}
  </style>
</head>
<body>
  <div class="app">
    <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
      <div><h1 style="margin:0;font-size:22px">StratBadEPS <small style="font-size:12px;color:var(--muted)">v2.9.5</small></h1><span id="saveIndicator">● Sauvegardé</span></div>
      <button class="btn ghost hidden" id="globalBackBtn">Quitter</button>
    </header>

    <section id="setup" class="card">
      <div style="margin-bottom:15px"><label style="display:block;color:var(--accent);font-weight:bold;margin-bottom:8px">1. Format de jeu :</label>
        <div style="display:flex; gap:10px">
          <button class="btn" id="mode3" style="flex:1">3 Joueurs</button>
          <button class="btn ghost" id="mode4" style="flex:1">4 Joueurs</button>
        </div>
      </div>
      <div style="margin-bottom:15px"><label style="display:block;color:var(--accent);font-weight:bold;margin-bottom:8px">2. Points par set :</label>
        <div id="scoreOptions" style="display:flex; gap:10px"></div>
      </div>
      <div style="margin-bottom:15px"><label style="display:block;color:var(--accent);font-weight:bold;margin-bottom:8px">3. Noms :</label>
        <div id="pnames">
          <input class="pname-input" type="text" value="Élève 1" />
          <input class="pname-input" type="text" value="Élève 2" />
          <input class="pname-input" type="text" value="Élève 3" />
          <input class="pname-input hidden" id="p4input" type="text" value="Élève 4" />
        </div>
      </div>
      <button class="btn" id="startBtn" style="width:100%; padding:15px; font-size:18px">Démarrer</button>
    </section>

    <section id="flow" class="hidden">
        <div id="matchHeader" style="margin-bottom:10px; font-size:14px; color:var(--accent); font-weight:bold"></div>
        <div id="chooseStage" class="card hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px"><b>Stratégie choisie</b><button class="btn ghost explainBtn">Aide</button></div>
            <div id="opponentsList"></div>
            <button class="btn" id="skipChoices" style="width:100%; margin-top:20px">Valider & Jouer</button>
        </div>
        <div id="playStage" class="card hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px"><h3 id="setTitle" style="margin:0">Set 1</h3><button class="btn ghost explainBtn">Aide</button></div>
            <div style="display:flex; gap:10px; margin-bottom:20px">
              <div class="score-box card"><div id="leftName">-</div><div class="score-val" id="leftScore">0</div><button class="btn" id="leftPlus" style="width:100%">+1 Point</button></div>
              <div class="score-box card" style="border: 2px solid var(--accent)"><div id="rightName">-</div><div class="score-val" id="rightScore">0</div>
                <div style="display:flex; flex-direction:column; gap:8px"><button class="btn" id="rightPlus">+1 Point</button><button class="btn ghost" id="rightPlusBonus" style="border-color:var(--accent)">+1 Pt Tactique</button></div>
              </div>
            </div>
            <button class="btn danger" id="undoBtn" style="width:100%">↩ Annuler dernier point</button>
        </div>
        <div id="guessStage" class="card hidden"><h3>Devinette</h3><div id="guessInputsList"></div><button class="btn" id="submitGuesses" style="width:100%; margin-top:20px">Valider</button></div>
        <div id="matchSummary" class="card hidden"><h3>Score provisoire</h3><div class="inter-table-container"></div><button class="btn" id="nextMatch" style="width:100%; margin-top:20px">Match Suivant</button></div>
    </section>

    <section id="final" class="hidden">
        <div class="card"><div id="finalScoreTableContainer"></div></div>
        <div class="card">
            <h3>Bilan Compétences</h3>
            <div style="overflow-x:auto"><table id="leaderboard"><thead><tr><th>Élève</th><th>Analyse</th><th>Réal.</th><th>Comp.</th><th>Note</th></tr></thead><tbody></tbody></table></div>
            <div style="margin-top:20px; display:flex; gap:10px"><button class="btn" id="exportCsvBtn" style="flex:1">Exporter CSV</button><button class="btn ghost" id="restart" style="flex:1">Reset</button></div>
        </div>
    </section>
  </div>

  <div id="modalHelp" class="modal"><div class="modal-content"><h3 style="margin-top:0; color:var(--accent)">Aide Stratégies</h3><ul id="helpList" style="font-size:14px; line-height:1.6; padding-left:20px"></ul><button class="btn" id="closeHelp" style="width:100%">Fermer</button></div></div>

  <script>
    // --- RÉTABLISSEMENT DES PHRASES D'AIDE ---
    const STRATS_DEF = [
        ["Alterner largeur", "Viser les couloirs latéraux pour faire courir son adversaire de gauche à droite."],
        ["Alterner profondeur", "Utiliser le dégagé de fond de court et/ou le lob en alternance avec les amortis pour faire courir son adversaire d'avant en arrière."],
        ["Fixer fond -> amorti", "Faire reculer l'adversaire au fond de court grâce à des dégagés pour conclure sur un amorti."],
        ["Fixer amorti -> lober", "Attirer l'adversaire au filet grâce à des amortis pour ensuite conclure le point sur un lob."],
        ["Viser les 4 coins", "Envoyer les volants de façon à viser les 4 coins du terrain en utilisant des dégagés, des lobs et/ou des amortis croisés."],
        ["Fixer sur son revers", "Viser le côté faible de l'adversaire pour le mettre en difficulté et obtenir des volants favorables."],
        ["Accélérer le jeu", "Utiliser des Smashs, des drives et des kills pour mettre l'adversaire sous pression temporelle."]
    ];
    const STRATEGIES = STRATS_DEF.map(s => s[0]);
    const VAL_MAP = { "D1": 1, "D2-": 1.5, "D2": 2, "D3-": 2.5, "D3": 3, "D4-": 3.5, "D4": 4 };
    
    let state = { gameMode: 3, pointLimit: 11, players: [], totals: [], matchData: [], currentMatch: 0, currentView: 'setup', activeSet: 0, liveScore: { l:0, r:0, rt:0 } };

    function save() { localStorage.setItem('stratBad_v295', JSON.stringify(state)); document.getElementById('saveIndicator').style.opacity = 1; setTimeout(() => document.getElementById('saveIndicator').style.opacity = 0, 800); }
    function load() { const data = localStorage.getItem('stratBad_v295'); if (data) { state = JSON.parse(data); renderView(); } }

    function updateScoreOptions() {
        const container = document.getElementById('scoreOptions');
        const scores = state.gameMode === 3 ? [7, 11] : [5, 7];
        container.innerHTML = scores.map(s => `<button class="btn ${s===state.pointLimit?'':'ghost'}" onclick="setLimit(${s}, this)">${s} pts</button>`).join('');
    }
    window.setLimit = (v, b) => { state.pointLimit = v; Array.from(b.parentElement.children).forEach(x=>x.classList.add('ghost')); b.classList.remove('ghost'); save(); };

    document.getElementById('mode3').onclick = () => { state.gameMode = 3; state.pointLimit=11; document.getElementById('mode3').className='btn'; document.getElementById('mode4').className='btn ghost'; updateScoreOptions(); document.getElementById('p4input').classList.add('hidden'); save(); };
    document.getElementById('mode4').onclick = () => { state.gameMode = 4; state.pointLimit=7; document.getElementById('mode4').className='btn'; document.getElementById('mode3').className='btn ghost'; updateScoreOptions(); document.getElementById('p4input').classList.remove('hidden'); save(); };
    updateScoreOptions();

    function renderView() {
        if (state.currentView === 'setup') {
            document.getElementById('setup').classList.remove('hidden'); document.getElementById('flow').classList.add('hidden'); document.getElementById('final').classList.add('hidden');
            document.getElementById('globalBackBtn').classList.add('hidden'); return;
        }
        document.getElementById('setup').classList.add('hidden'); document.getElementById('flow').classList.remove('hidden'); document.getElementById('globalBackBtn').classList.remove('hidden');
        ['chooseStage','playStage','guessStage','matchSummary'].forEach(s => document.getElementById(s).classList.add('hidden'));
        if (state.currentView === 'final') { document.getElementById('flow').classList.add('hidden'); document.getElementById('final').classList.remove('hidden'); renderFinal(); } 
        else if (state.currentView === 'choose') { document.getElementById('chooseStage').classList.remove('hidden'); renderMatchSelect(); }
        else if (state.currentView === 'play') { document.getElementById('playStage').classList.remove('hidden'); renderPlay(); }
        else if (state.currentView === 'guess') { document.getElementById('guessStage').classList.remove('hidden'); renderGuess(); }
        else if (state.currentView === 'summary') { document.getElementById('matchSummary').classList.remove('hidden'); renderSummaryTable('.inter-table-container'); }
    }

    document.getElementById('startBtn').onclick = () => {
        const inputs = document.querySelectorAll('.pname-input');
        state.players = Array.from(inputs).slice(0, state.gameMode).map(i => ({ name: i.value || "Élève" }));
        state.totals = state.players.map(() => ({ matchPoints:0, tacticalPoints:0, totalPointsScored:0, correctGuesses:0 }));
        state.matchData = state.players.map((_, i) => ({ dev:i, opponents: state.players.map((x,idx)=>idx).filter(x=>x!==i), choices:{}, sets:[] }));
        state.currentView = 'choose'; state.currentMatch = 0; save(); renderView();
    };

    function renderMatchSelect() {
        const md = state.matchData[state.currentMatch];
        document.getElementById('matchHeader').textContent = `Match ${state.currentMatch+1} • Obs : ${state.players[md.dev].name}`;
        const list = document.getElementById('opponentsList'); list.innerHTML = '';
        md.opponents.forEach(oppIdx => {
            const div = document.createElement('div');
            div.innerHTML = `<label style="display:block;margin:10px 0">Stratégie de ${state.players[oppIdx].name} :</label><div class="strategies"></div>`;
            const stratCont = div.querySelector('.strategies');
            STRATEGIES.forEach((s, idx) => {
                const b = document.createElement('button'); b.className = (md.choices[oppIdx] === idx) ? 'btn' : 'btn ghost';
                b.textContent = s; b.style.fontSize = '10px'; b.style.margin = '2px';
                b.onclick = () => { md.choices[oppIdx] = idx; Array.from(stratCont.children).forEach(x=>x.className='btn ghost'); b.className='btn'; save(); };
                stratCont.appendChild(b);
            });
            list.appendChild(div);
        });
    }

    document.getElementById('skipChoices').onclick = () => { state.currentView = 'play'; state.activeSet = 0; state.liveScore = {l:0, r:0, rt:0}; save(); renderView(); };

    function renderPlay() {
        const md = state.matchData[state.currentMatch]; const oppIdx = md.opponents[state.activeSet];
        document.getElementById('setTitle').textContent = `Set ${state.activeSet+1}/${state.gameMode-1}`;
        document.getElementById('leftName').textContent = state.players[md.dev].name;
        document.getElementById('rightName').textContent = state.players[oppIdx].name;
        updateLiveScoreUI();
    }

    document.getElementById('leftPlus').onclick = () => { state.liveScore.l++; updateLiveScoreUI(); checkSetEnd(); };
    document.getElementById('rightPlus').onclick = () => { state.liveScore.r++; updateLiveScoreUI(); checkSetEnd(); };
    document.getElementById('rightPlusBonus').onclick = () => { state.liveScore.r++; state.liveScore.rt++; updateLiveScoreUI(); checkSetEnd(); };
    document.getElementById('undoBtn').onclick = () => { if(state.liveScore.l>0)state.liveScore.l--; else if(state.liveScore.r>0)state.liveScore.r--; updateLiveScoreUI(); };

    function updateLiveScoreUI() { document.getElementById('leftScore').textContent = state.liveScore.l; document.getElementById('rightScore').textContent = state.liveScore.r; save(); }
    
    function checkSetEnd() {
        if (state.liveScore.l >= state.pointLimit || state.liveScore.r >= state.pointLimit) {
            const md = state.matchData[state.currentMatch];
            md.sets.push({ ...state.liveScore, left: md.dev, right: md.opponents[state.activeSet] });
            state.activeSet++; state.liveScore = {l:0, r:0, rt:0};
            if (state.activeSet >= state.gameMode-1) state.currentView = 'guess';
            save(); renderView();
        }
    }

    function renderGuess() {
        const md = state.matchData[state.currentMatch]; const list = document.getElementById('guessInputsList'); list.innerHTML = '';
        md.opponents.forEach(oppIdx => {
            list.innerHTML += `<div style="margin-bottom:15px"><label>Qu'a fait ${state.players[oppIdx].name} ?</label>
            <select class="guess-sel" data-opp="${oppIdx}" style="width:100%;padding:12px;margin-top:5px;background:#000;color:#fff;border:1px solid #444;border-radius:8px">
                <option value="">-- Choisir --</option>${STRATEGIES.map((s,i) => `<option value="${i}">${s}</option>`).join('')}
            </select></div>`;
        });
    }

    document.getElementById('submitGuesses').onclick = () => {
        const md = state.matchData[state.currentMatch];
        document.querySelectorAll('.guess-sel').forEach(sel => { if(parseInt(sel.value) === md.choices[parseInt(sel.dataset.opp)]) state.totals[md.dev].correctGuesses++; });
        md.sets.forEach(s => {
            if(s.l > s.r) { state.totals[s.left].matchPoints += 3; state.totals[s.right].matchPoints += 1; }
            else { state.totals[s.right].matchPoints += 3; state.totals[s.left].matchPoints += 1; }
            state.totals[s.right].totalPointsScored += s.r; state.totals[s.right].tacticalPoints += s.rt;
        });
        state.currentView = 'summary'; save(); renderView();
    };

    document.getElementById('nextMatch').onclick = () => { state.currentMatch++; state.currentView = (state.currentMatch >= state.gameMode) ? 'final' : 'choose'; save(); renderView(); };

    function renderSummaryTable(selector) {
        let h = `<table><thead><tr><th>Élève</th><th>Match</th><th>Tact.</th><th>Devin.</th><th>TOTAL</th></tr></thead><tbody>`;
        state.players.forEach((p, i) => { const t = state.totals[i]; h += `<tr><td>${p.name}</td><td>${t.matchPoints}</td><td>${t.tacticalPoints}</td><td>${t.correctGuesses*3}</td><td><b>${t.matchPoints + t.tacticalPoints + (t.correctGuesses*3)}</b></td></tr>`; });
        document.querySelectorAll(selector).forEach(c => c.innerHTML = h + `</tbody></table>`);
    }

    function getCrossedDegre(d1, d2) {
        const s1 = parseInt(d1[1]), s2 = parseInt(d2[1]); const min = Math.min(s1, s2), max = Math.max(s1, s2), diff = max - min;
        if (diff === 0) return `D${min}`; if (diff === 1) return `D${max}-`; return `D${min + 1}`; 
    }

    function renderFinal() {
        renderSummaryTable('#finalScoreTableContainer');
        const tbody = document.querySelector('#leaderboard tbody'); tbody.innerHTML = '';
        state.players.forEach((p, i) => {
            const t = state.totals[i];
            let dAn = (state.gameMode === 3) ? (t.correctGuesses === 2 ? "D4" : (t.correctGuesses === 1 ? "D3" : "D1")) : (t.correctGuesses === 3 ? "D4" : (t.correctGuesses === 2 ? "D3" : (t.correctGuesses === 1 ? "D2" : "D1")));
            const ratio = t.totalPointsScored > 0 ? (t.tacticalPoints/t.totalPointsScored)*100 : 0;
            let dRe = ratio > 50 ? "D4" : (ratio >= 33 ? "D3" : (ratio >= 25 ? "D2" : "D1"));
            const comp = getCrossedDegre(dAn, dRe);
            tbody.innerHTML += `<tr><td><b>${p.name}</b></td><td><span class="degre-badge ${dAn}">${dAn}</span></td><td><span class="degre-badge ${dRe}">${dRe}</span></td><td><span class="degre-badge ${comp.replace('-','minus')}">${comp}</span></td><td><b>${VAL_MAP[comp] || 1}/4</b></td></tr>`;
        });
    }

    // --- EXPORT COMPLET (2 TABLEAUX) ---
    document.getElementById('exportCsvBtn').onclick = () => {
        let csv = "\uFEFF"; // BOM pour Excel accents
        // 1. Tableau Récapitulatif
        csv += "RECAPITULATIF DES MATCHS\n";
        csv += "Eleve;Points Match;Points Tactiques;Points Devinettes;TOTAL SCORE\n";
        state.players.forEach((p, i) => {
            const t = state.totals[i];
            csv += `${p.name};${t.matchPoints};${t.tacticalPoints};${t.correctGuesses*3};${t.matchPoints + t.tacticalPoints + (t.correctGuesses*3)}\n`;
        });
        csv += "\n\n";
        // 2. Tableau Bilan
        csv += "BILAN DES COMPETENCES\n";
        csv += "Eleve;Degre Analyse;Degre Realisation;Competence Finale;Note /4\n";
        state.players.forEach((p, i) => {
            const t = state.totals[i];
            let dAn = (state.gameMode === 3) ? (t.correctGuesses === 2 ? "D4" : (t.correctGuesses === 1 ? "D3" : "D1")) : (t.correctGuesses === 3 ? "D4" : (t.correctGuesses === 2 ? "D3" : (t.correctGuesses === 1 ? "D2" : "D1")));
            const ratio = t.totalPointsScored > 0 ? (t.tacticalPoints/t.totalPointsScored)*100 : 0;
            let dRe = ratio > 50 ? "D4" : (ratio >= 33 ? "D3" : (ratio >= 25 ? "D2" : "D1"));
            const comp = getCrossedDegre(dAn, dRe);
            csv += `${p.name};${dAn};${dRe};${comp};${VAL_MAP[comp] || 1}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.setAttribute("download", `Bilan_BadEPS_${new Date().toLocaleDateString()}.csv`);
        link.click();
    };

    document.getElementById('restart').onclick = () => { if(confirm("Effacer tout ?")) { localStorage.clear(); location.reload(); } };
    document.getElementById('globalBackBtn').onclick = () => { if(confirm("Quitter ?")) { localStorage.clear(); location.reload(); } };
    const helpL = document.getElementById('helpList'); STRATS_DEF.forEach(s => helpL.innerHTML += `<li style="margin-bottom:8px"><b>${s[0]} :</b> ${s[1]}</li>`);
    document.querySelectorAll('.explainBtn').forEach(b => b.onclick = () => document.getElementById('modalHelp').style.display='flex');
    document.getElementById('closeHelp').onclick = () => document.getElementById('modalHelp').style.display='none';
    load();
  </script>
</body>
</html>